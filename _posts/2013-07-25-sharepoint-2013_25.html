---
layout: post
title: "Связанные элементы в SharePoint 2013"
date: '2013-07-25T10:00:00.000+04:00'
author: "Станислав Выщепан"
tags:
- js
- sp2013
- SharePoint
modified_time: '2013-07-25T10:00:05.978+04:00'
thumbnail: http://lh5.ggpht.com/-ZrqixnTyfSU/Ue612BqGNuI/AAAAAAAAAVo/hzQlkOCccAk/s72-c/image_thumb%25255B5%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-1302241583051203640.post-2266813458919972998
blogger_orig_url: http://blog.gandjustas.ru/2013/07/sharepoint-2013_25.html
redirect_from: /2013/07/sharepoint-2013_25.html
category: SharePoint  2013
---

<p>Вам наверное часто в решениях требовалось сделать возможность связать один элемент с другим. Причем не просто лукап сделать, а так чтобы можно было произвольно выбрать элемент и создать связь с ним.</p> <p>Копая JSOM, я недавно обнаружил, что в SharePoint 2013 есть такой функционал.</p> <p>“Изкаропки” он доступен в списке задач. У каждой задачи есть “связанные элементы”.</p> <p><a href="http://lh3.ggpht.com/-lW1TkFiMWAQ/Ue611IrEenI/AAAAAAAAAVg/Vj4fkvJe7Bo/s1600-h/image%25255B4%25255D.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://lh5.ggpht.com/-ZrqixnTyfSU/Ue612BqGNuI/AAAAAAAAAVo/hzQlkOCccAk/image_thumb%25255B5%25255D.png?imgmax=800" width="554" height="413"></a> </p> <p>При нажатии на “добавить связанный элемент” появляется стандартный asset picker</p> <p><a href="http://lh3.ggpht.com/-bXCI4NGfMSc/Ue6120XB1EI/AAAAAAAAAVw/Tg9uzxPyoPk/s1600-h/image%25255B9%25255D.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://lh6.ggpht.com/-Tz_vJk0ZRF4/Ue613WFyP0I/AAAAAAAAAV4/fWZbxWD6jr8/image_thumb%25255B11%25255D.png?imgmax=800" width="554" height="300"></a> </p> <p>Можно выбирать любой элемент в пределах коллекции сайтов.</p> <p></p> <h3>Внутренности “связанных элементов”</h3> <p>“Связанные элементы” это кастомное поле с ID равным значению <strong><em>Microsoft.SharePoint.SPBuiltInFieldId.RelatedItems</em></strong>. Это поле скрытое и добавить его в список из интерфейса не получится. Но в решении вы совершенно спокойно можете добавить это поле в тип контента.</p> <p>Сам касс поля определен в сборке Microsoft.SharePoint и доступен, в том числе, в Foundation. Для работы с полем доступны только клиентские API, серверный класс для них помечен как internal. </p> <p>На клиенте можно обращаться с помощью классов <em>SP.RelatedItemManager</em> в <em>sp.js</em> (<a title="http://msdn.microsoft.com/en-us/library/jj838582.aspx" href="http://msdn.microsoft.com/en-us/library/jj838582.aspx">http://msdn.microsoft.com/en-us/library/jj838582.aspx</a>) и <em>Microsoft.SharePoint.Client.RelatedItemManager</em> в сборке <em>Micrsosoft.SharePoint.Client</em> (<a title="http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.client.relateditemmanager.aspx" href="http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.client.relateditemmanager.aspx">http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.client.relateditemmanager.aspx</a>).</p> <p>Если интересна реализация поля, то смотрите с помощью IlSpy класс <em>Microsoft.SharePoint.RelatedItemManager</em> в сборке <em>Microsoft.SharePoint.</em> Рендеринг поля описан в файле sp.ui.relateditems.js</p> <p>Реализация поля предельно простая – в текстовом поле сохраняется сериализованный в json массив элементов <em>Microsoft.SharePoint.RelatedItem</em>. Есть ограничение – <strong>не более 9 связанных элементов</strong>. Скорее всего оно связано с необходимостью secutrity trimming ссылок на связанные элменты, а это делается крайне медленно в SharePoint. Для security trimming ссылок в ленте новостей используется поиск+кеширование, но функционал “связанных элементов” рассчитан на работу в foundation и не может использовать такие возможности.</p> <h3>Применение</h3> <p>Из-за ограничения количества связанных элементов использовать данную возможность для разработки большой системы не получится. Хотя во многих сценариях данное поле может заменить лукапы. Кроме того API позволит вычислять “транзитивное замыкание” связанных элементов.</p> <p>Наибольший интерес “связанные элементы” представляют как пример качественно сделанного расширения платформы. Оно включает в себя Custom Field Type с контролом, API на сервере и на клиенте, рендеринг поля в формах и использование asset picker. Если будете делать что-то подобное, то изучите реализацию “связанных элементов”.</p>  
