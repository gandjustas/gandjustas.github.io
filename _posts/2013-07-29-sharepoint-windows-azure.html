---
layout: post
title: "Машина разработчика SharePoint в Windows Azure"
date: '2013-07-29T10:00:00.000+04:00'
author: "Станислав Выщепан"
tags:
- Azure
- sp2013
- SharePoint
modified_time: '2013-07-29T10:00:02.461+04:00'
blogger_id: tag:blogger.com,1999:blog-1302241583051203640.post-6551064566261670194
blogger_orig_url: http://blog.gandjustas.ru/2013/07/sharepoint-windows-azure.html
redirect_from: /2013/07/sharepoint-windows-azure.html
category: Облака
---

<p>Ранее я занимался разработкой под SharePoint&nbsp; на компьютере, стоящим под столом. На нем была развернута виртуальная ферма. Последнее время я всю разработку перенес в облако. Apps отлаживаю на Office 365, серверный код SharePoint создаю и отлаживаю на виртуальной машине в Windows Azure, код храню в Team Foundation Service.</p> <p>Office 365 и Team Foundation Service – это SaaS, поэтому не вызывает проблем использование и расчет эффективности. А вот виртуалки в Windows Azure (Iaas) вызывают много вопросов.</p> <h3>Почему облака</h3> <h4>Доступность</h4> <p>Виртуалка с SharePoint чаще всего нужна когда, когда я не нахожусь дома. С виртуалкой в Azure я могу получит доступ к ней хоть с планшета. Кроме того виртуалки в Azure работают гораздо надежнее, чем дома или, например, в офисе.</p> <p>Кроме того в Azure виртуальные машины имеют очень толстый канал в интернет, поэтому скачивание дистрибутивов и обновлений происходит за считанные минуты.</p> <h4>Гибкость</h4> <p>Второе преимущество виртуалки в Azure – большая гибкость. В несколько кликов можно добавить или убрать ресурсы (не забываем что за них платить надо), добавить диски или создать новые машины (очень полезно для тестирования).</p> <p>На домашнем компьютере ресурсы сильно ограничены, а виртуализация только создает иллюзию, не позволяя реально масштабировать инфраструктуру. </p> <h4>Бесплатно</h4> <p>Как владельцу MSDN подписки мне это ничего не стоит. Если же вам все таки придется платить, то расчеты в конце.</p> <h3>Конфигурация</h3> <p>Для того чтобы поднять полноценную среду для разработки вам нужны: контроллер домена с DNS сервером, SQL Server и собственно сам SharePoint. Для целей демонстрации еще понадобится Office Web Apps Server. Причем DC и WebApps должны стоять отдельно, а SQL Server и SharePoint можно совместить. Для разработки это удобно, так как это увеличивает утилизацию ресурсов и не надо по отдельности выключать виртуалки.</p> <p>А теперь по порядку:</p> <h4>Сеть</h4> <p>Чтобы виртуалки видели друг друга, для начала надо создать виртуальную сеть. Все виртуалки начинают получать адреса по порядку из этой сети. Причем начиная с xx.xx.xx.4 и в порядке включения. В настройках сети также задаются адреса внутренних DNS серверов. <em>Руками править настройки сети в Azure нельзя! </em>Это означает что DNS серверы должны быть включены всегда или должны включаться в определенном порядке, чтобы из IP адреса не менялись.</p> <p>У меня один DNS сервер на контроллере домена на XS виртуалке и он всегда включен.</p> <h4>Контроллер домена</h4> <p>Тут все просто. Одна XS виртуалка и дополнительный диск для данных домена. Установлены роли AD DS и DNS. Если понадобятся сертификаты, то надо добавить AD CS.</p> <h4>Машина разработчика</h4> <p>Я использую XL виртуалку, на которой стоит SQL Server и SharePoint 2013. На борту 8 ядер (честных, не виртуальных) и 14 ГБ памяти. Для целей разработки этого более чем достаточно.</p> <p>Но самое главное при работе SharePoint это диски. Быстродействие фермы SharePoint упирается в первую очередь в диски. Когда вы читаете документацию по развертыванию SQl Server и SharePoint там указаны требования к объему дисков, неявно предполагая что все это разные физические диски или как минимум разные LUNы на СХД. Когда разворачивается тестовая ферма или ферма для разработки, то все виртуальные диск попадают на один физический и все дико тормозит. </p> <p>Диски в Windows Azure это блобы в Azure Storage. Максимальня пропускная способность одного блоба – 60 мегабайт в секунду(<a title="http://blogs.msdn.com/b/windowsazure/archive/2012/11/02/windows-azure-s-flat-network-storage-and-2012-scalability-targets.aspx" href="http://blogs.msdn.com/b/windowsazure/archive/2012/11/02/windows-azure-s-flat-network-storage-and-2012-scalability-targets.aspx">http://blogs.msdn.com/b/windowsazure/archive/2012/11/02/windows-azure-s-flat-network-storage-and-2012-scalability-targets.aspx</a>). Внутри виртуальной машины файлы между дисками копируются со скоростью 10 мегабайт в секунду. Но самое главное что для масштабирования IO вы можете добавить столько дисков сколько нужно.</p> <p>Для SharePoint+SQL Server оптимальной будет такая конфигурация:</p> <ul> <li>Диск для данных SQL (можно масштабировать по количеству баз)</li> <li>Диск для логов SQL (можно масштабировать по количеству баз)</li> <li>Диск для tempdb</li> <li>Диск для текстовых логов IIS и SharePoint</li> <li>Диск для индекса поиска</li></ul> <p>Кроме того можно подключать два виртуальных диска и делать из них striped volume, что должно увеличивать пропускную способность в два раза, но это надо тестировать, я разницы между обычными дисками и striped не увидел при нагрузочном тестировании.</p> <p>Такая конфигурация работает быстрее, чем на домашнем компьютере.</p> <h3>Тестирование</h3> <p>Для тестов я поднял еще одну машину с Visual Studio и сделал нагрузочный тест для SharePoint. Увы базы SharePoint у меня пустые и кастома почти нет, поэтому результаты тестирования не очень показательны.</p> <p>Нагрузочный тест открывал главные страницы сайтов разных шаблонов. Нагрузка росла равномерно с 10 виртуальных пользователей до 200.</p> <p>Результаты нагрузочного теста:</p> <ul> <li>100 requests per senond</li> <li>Все уперлось в процессоры (75% IIS, 25% SQL)</li> <li>Памяти свободной – 1,5 гб (потому что базы пустые)</li> <li>Диски загружены на 15% максимум</li> <li>Примерно на 70 виртуальных пользователях некоторые страницы стали отвечать более 10 секунд</li> <li>IIS ошибок не отдавал</li></ul> <p>Интересные наблюдения:</p> <ul> <li>Для WFE в SharePoint очень важны процессоры, так как страницы “тяжелые” и требуют много ресурсов на рисование.</li> <li>WFE дает нагрузку на диск из-за записи текстовых логов (около 3 мб\сек) в режиме Verbose.</li> <li>Для SQL очень важны диски. Даже в сценарии открытия страниц нагрузка на LOG файлы БД около 1,5 мб\сек.</li> <li>Поиск SharePoint все кеширует в памяти, поэтому для серверов поиска очень важен объем памяти. А также диск, он влияет на скорость индексирования.</li></ul> <h3>Стоимость</h3> <p>В Azure считается время работы машин, гигабайты данных, количество транзакций и трафик. Самое дорогое, естественно, часы виртуальных машин. На время неактивности машины надо отключать.</p> <p>Расходы:</p> <ul> <li>DC – виртуалка XS, работает постоянно – 491 рублей в месяц.</li> <li>SharePoint – виртуалка XL, работает в среднем 172 часа в месяц (8x5) - 4086,72 рублей в месяц.</li> <li>100гб данных – 231 рублей в месяц.</li> <li>Трафик и тразакции за месяц на разработческой машине стоят меньше 100 рублей.</li></ul> <p><strong>Итого</strong> – чуть меньше 5 тысяч рублей в месяц. С подпиской MSDN дешевле почти в 2 раза. </p> <p>Для сравнения с настольный компьютер той же мощности обойдется примерно в 50 тысяч рублей и более (чтобы обеспечить такую же скорость и отказоустойчивость хранилища). </p> <h4>Масштабирование</h4> <p>Для команд разработки SharePoint иметь машины на Azure может быть очень выгодно. Сильно повышается мобильность. Можно сэкономить на использовании общего SQL Server на несколько разработчиков, ведь диски масштабируются практически бесплатно.</p> <h3>Заключение</h3> <p>Если вы собираетесь заниматься разработкой и тестированием, то обязательно рассмотрите развертывание инфраструктуры в Azure. Даже если вы – крупный интегратор с кучей внутренних ресурсов, то использование облака может оказаться гораздо удобнее.</p>  
