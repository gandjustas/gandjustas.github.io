---
layout: post
title: "Как работает развертывание решений в SharePoint"
date: '2013-12-12T10:00:00.000+04:00'
author: "Станислав Выщепан"
tags:
- Architecture
- SharePoint
modified_time: '2013-12-12T12:08:22.121+04:00'
blogger_id: tag:blogger.com,1999:blog-1302241583051203640.post-2262476543448302721
blogger_orig_url: http://blog.gandjustas.ru/2013/12/sharepoint-solution-deployment.html
redirect_from: /2013/12/sharepoint-solution-deployment.html
category: SharePoint
---

<p>Развертывание решений SharePoint - это нескончаемый источник ошибок, слухов и легенд. Причина этому простая – процесс деплоймента (и отката) решений практически никак не документирован. Начиная с SharePoint 2010 ситуация усложнилась появлением sandbox solutions и механизмом апгрейда фич.</p> <h3>Общая схема</h3> <p><img src="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-81-08-metablogapi/5344.image_5F00_1BFF7C40.png" width="560" height="390"></p> <p>(взято <a href="http://blogs.msdn.com/b/vesku/archive/2013/11/06/ftc-to-cam-stop-creating-content-types-and-site-columns-declaratively.aspx" target="_blank">отсюда</a>)</p> <p>По пунктам:</p> <ul> <li>WSP пакет сначала попадает в конфигурационную базу  <li>При развертывании файлы из пакета попадают на компьютеры фермы, это касается фич, сборок и файлов приложения.  <li>При активации фич на основе манифеста в контентной базе создаются записи, которые ссылаются на файлы на диске.</li></ul> <p>Такая схема была изобретена в ранних версиях SharePoint, чтобы экономить место в базе, если одна и та же функциональность используется на многих сайтах. Кроме того так очень удобно обновлять, достаточно развернуть новую версию пакета и все сайты получат изменения.</p> <p>На практике такая схема работает плохо...</p> <h3>Проблемы</h3> <p>Когда артефакты (файлы, поля, типы контента, списки) создаются таким образом, как описано выше, они называются ghosted (в SharePoint 2007) или uncustomized (с SharePoint 2010). </p> <p>Проблемы начинаются тогда, когда файлы\поля\типы\списки изменяются. Когда это происходит в базу записывается схема (XML определение) или сам обновленный файл, а связь с файлом на диске теряется. Это состояние называется unghosted или customized. Дальнейшее обновление путем обновления файлов на диске уже перестает работать.</p> <p>Ситуация усугубляется тем, что деактивация фич не удаляет списки и файлы и не удаляет типы контента и поля, на которые ссылаются списки. Повторная активация фич, при наличии артефактов в контентной базе, работает совершенно непредсказуемо. </p> <blockquote> <p>Это кстати одна из базовых ошибок дизайна feature framework, из-за которой весь деплоймент стал невероятно сложным. Если бы деактивация фич удаляла все артефакты и при удалении решения фичи деактивировались, то делать решения стало бы гораздо легче. Но в 2007 году об этом не подумали и сделали выбор в пользу сохранения данных, а не контролируемости развертывания.</p></blockquote> <p>Можно, конечно, все артефакты создавать с помощью XML, избегая кода, который вызывает кастомизацию. Но далеко не все решения можно делать таким образом. Многие вещи, вроде таксономии, audience targeting и metadata mavigation в XML описать очень сложно. Но самое главное, что кастомизация может быть вызвана пользователем. А если возможность кастомизации заблокировать, то теряется гибкость, которую дает SharePoint.</p> <p>Еще одна проблема связана со списками и шаблонами (определениями) списков. Если список создан по шаблону и не кастомизирован, но шаблон отсутствует на диске, то появляется множество непонятных ошибок при использовании API и некоторых стандартных функций.</p> <p>Из-за этих проблем многие полностью отказались от развертывания артефактов с помощью XML определений и начали делать создание артефактов с помощью кода. Этот подход гораздо более многословен и повышает вероятность ошибок, но при этом дает контролируемость процесса при создании, и самое важное, при обновлении артефактов.</p> <h3>SharePoint 2010 и Sandbox</h3> <p>Естественно в Microsoft обо всех этих проблемах знали и в 2010 версии сделали некоторые изменения, которые должны были улучшить ситуацию.</p> <p>Первое изменение – добавление флагов Overwrite в определениях полей и типов контента. С этим флагом поля и типы при активации фичи записываются в контентную базу, без создания привязки к файлам на диске. Кроме того стала возможна повторная активация фич при наличии артефактов в контентной базе данных. Это частично решает проблему, но только частично, так как проблема со списками, созданными из шаблонов, не решается.</p> <p>Второе изменение – добавление возможности апгрейда фич. Теперь можно не удалять решение и не переактивировать фичи для получения новой функциональности.</p> <p>Третье изменение – появление Sandbox решений, которые не используют файлы в файловой системе и создают все артефакты сразу в контентной базе. При этом откат Sandbox решения вызывает деактивацию всех фич, а для FullTrust такого не происходит.</p> <blockquote> <p>Казалось бы теперь можно сделать то что нужно, используя правильные возможности. Но вышла еще одна промашка – все изменения почти никак не документированы и процесс развертывания стал еще более непредсказуемый и вообще сложилась ситуация когда никто не знает как делать правильно.</p></blockquote> <p>В SharePoint 2013 кстати тоже произошли небольшие улучшения, но снова почти не документированные.</p> <h3>Что же делать</h3> <p>Вариант первый – делать все кодом. К сожалению кода получается очень много и писать его очень муторно. Некоторые вещи сделать кодом сложно, некоторые вообще невозможно.</p> <p>Вариант второй – делать развертывание в XML, не деактивировать фичи (особенно если ведет к потерям данных или к нарушению работоспособности), не откатывать решение, использовать feature upgrade. Это тоже требует написания кода, но в гораздо меньшем объеме.</p> <p>Кстати использовать активацию фич для поставки функционала пользователю – тоже не лучший вариант. Гораздо лучше:</p> <ol> <li>Создание сайтов по шаблону.  <li>Создание списков по шаблону.  <li>Дополнительными пунктами в меню администрирования (для сайтов, списков, типов контента).  <li>Расширением существующего функционала.</li></ol> <p>Сам фичи лучше всего делать скрытыми, активировать их автоматически при развертывании решения или скриптом установки.</p> <p>Если же делаете фичу видимой, то нужно всегда тестировать возможность её многократной активации\деактивации, в том числе на разных сайтах и коллекциях сайтов.</p> <h3>Заключение</h3> <p>Если вы работаете с SharePoint, то вам в любом случае необходимо знать как работает развертывание артефактов. Узнать это можно типовым для SharePoint способом – ковырянием сборок в ILSpy или Reflector. Большую часть из того, что я описал в этом посте я узнал именно из сборки Microsoft.SharePoint.</p> <p>В следующий раз расскажу как пользоваться работает feature upgrade и как быстро создавать решения в SharePoint.</p>  
