---
layout: post
title: "SharePoint 2016 для архитекторов"
date: '2016-04-11T6:00:00.000+03:00'
category: SharePoint 2016
author: "Станислав Выщепан"
excerpt_separator: <!--more-->
header-img: img/sharepoint-large-dark.png
tags:
- SharePoint
- sp2016
---

Месяц назад SharePoint 2016 стал RTM. Это значит, что изменений в функционале SharePoint в ближайшие полгода мы не увидим.

SharePoint 2016 еще не GA (General Availability), то есть вы не сможете получить полноценный лицензионный ключ, только триал. Но уже пора думать о переходе на новую версию.  

В SharePoint 2016 мало изменений с точки зрения пользователя или разработчика, зато много с точки зрения администратора и архитектора.

Подробнее рассмотрим новшества.
<!--more-->

### Project Server
Это первое о чем вы узнаете еще до установки SharePoint 2016. SharePoint и Project Server теперь одно целое. Ставятся они вместе, таблицы project хранятся в контентной базе SharePoint. Для включения Project Server 2016 достаточно одной команды PowerShell. С точки зрения маркетинга и продаж это все еще разные продукты.  

Непонятно хорошо ли Project Server будет от такого тесного соседства с SharePoint. Раньше прожект пытался дистанцироваться от шарика, были рекомендации иметь для Project Server отдельную ферму, заказчики не всегда знали, что для Project Server нужен SharePoint eCAL. Посмотрим что будет в новой версии.

### Нет больше Foundation и не поддерживается SQL Express
Огромный удар для кучи партнеров Microsoft, которые продавали ~~змеиный яд~~ решения на бесплатной версии. Microsoft решил отказаться от беслатной версии, приучая клиентов платить за SharePoint. Помоему очень хорошее решение, так как большинство разработок на Foundation по большей части состоит из неумело повторенных фич платной версии SharePoint.  

У Microsoft была стратегия, что бесплатная версия Foundation должна продавать платную. WSS 2.0 даже включили в состав Windows Server 2003R2. Получилось ровно обратное - при наличии бесплатного Foundation заказчики даже не рассматривали платную версию.  

Доходило до смешного: я недавно получил запрос на оценку разработки портала. Там требовались профили и личные сайты, синхронизация с AD, древовидные справочники, поиск по контенту, социальные фичи. Но все это должно было работать на Foundation. 

SQL Express иногда использовали для разработческих\демонстрационных сред. Но теперь SQL Server Developer Edition бесплата для всех зарегистрированных разработчиков, поэтому потребность в Express-версии гораздо ниже.

### Минимальные требования 
Процессоров и памяти для SharePoint 2016 требуется столько же, сколько для 2013. Я бы рекомендовал иметь один сервер минимум с 16 гб оперативки и 4 ядрами для SharePoint+SQL для 300 активных пользователей, которые заходят на портал и что-то делают минимум раз в день. При росте количества пользователей масштабировать службы, которые не выдерживают нарузки.

Требования к софту изменились сильно - минимум Windows Server 2012R2 и SQL Server 2014 SP1, а лучше SQL Server 2016, чтобы поставить Reporting Services и PowerPivot. Минимальная поддерживаемая версия IE - 10, видимо потому, что используется CSS 3.

### Нет больше Standalone режима установки
Еще со времен WSS 2.0 (может и раньше, я не в курсе) в SharePoint было два режима - Ферма и Standalone. Ферма могла быть развернута на нескольких серверах и требовала доменных учеток, а Standalone работал с локальными учетками и мог ставится даже без AD.  

В SharePoint 2010 без AD стало невозможно установить SharePoint, а в Standalone было огромное количество багов. При этом ферму, поставленную в Standalone, было практически невозможно масштабировать. Надо было еще в 2013 отказаться от этого режма, но почему-то его оставили и убрали только сейчас.

### MinRole
Во время запуска Configuration Wizard спрашивают какя роль будет у сервера. Указав роль вы получете набор Service Application на этом сервере без возможности этот набор изменить. Кроме роли Custom, при которой вы сможете настроить службы на сервере самостоятельно.  

С одной стороны это упрощает настройку. С другой - отказоустойчивая ферма теперь требует 8 серверов SharePoint (4 роли * 2 сервера), это в дополнение к двум серверам для баз данных и двум серверам для Office Online Server.  

Мне кажется, что в реальности такое количество серверов никто поднимать не будет. Тем более на практике отказоустойчивую ферму можно собрать на 4 серверах вместо 8.

### Распределенный кэш
В SharePoint 2013 была проблема. Он использовал AppFabric Cache 1.0, который содержал утечки памяти. Надо было руками патчить его до последнего Cumulative Update. В SharePoint 2016 теперь ставится AppFabric сразу с CU7.

Но есть другая проблема - тайм-ауты. По умолчанию для некоторых кэшей SharePoint имеет тайм-ауты в 2 миллисекунды. Если кэш стоит не на отдельном сервере, то выдержать такой тайм-аут даже при минималной загрузке не получается. После этого SharePoint думает что кэш не работает и включает fallback-механизм, который снижает скорость загрузки старниц в разы.

При полностью рабочем кэше на односерверной ферме в Azure без нагрузки странцы отдаются за 1,5 секунды. Если кэш не работает, то время может доходить до 7 секунд.  

На technet есть [официальный гайд по настройке тайм-аутов](https://technet.microsoft.com/ru-ru/library/jj219613.aspx#finetune), он акутален как для SharePoint 2013, так и для 2016. Но в 2016 появились еще несколько кэшей (_ContainerType_):  

* DistributedSharedWithUserCache
* DistributedUnifiedGroupsCache
* DistributedFileLockThrottlerCache
* DistributedResourceTallyCache
* DistributedHealthScoreCache  

Для них тоже стоит увеличить тайм-ауты, особенно в случае односерверной фермы.

### Site Masters и баг в личных сайтах
Для создания личных сайтов в SharePoint 2016 используется новый механизм, называемый Site Masters. Вместо создания новой сайт-коллекции и активирования фич с запуском кода, создается одна скрытая сайт-коллекция (master), а из нее новые коллекции получаются просто копированием на уровне базы данных. Можно самостоятельно добавить мастеры для шаблонов сайтов, если надо будет массово создавать коллекции по этим шаблонам.

Эта фича ускоряет создание коллекций, но несет потенциальную проблему. Если в мастере не активирована нужная фича или просто есть ошибка, то все коллекции на основе этого мастера будут ошибку содержать. 

Как раз в личных сайтах в SharePoint 2016 есть ошибка. Шаблон по-умолчанию не содержит фичи для социальной ленты. В зависимости от последовательноси действий это может привести к тому, что личные сайты не будут создаваться вообще или создастся мастер без нужной фичи (еще непонятно что хуже). 

Я сделал [фикс для этой проблемы](https://github.com/gandjustas/SP2016PersonalSiteFix/). Надо скачать себе все файлы из репозитария, запустить build.cmd и установить на ферму полученный WSP-файл. Это обязательно надо сделать до первого захода на личный сайт. Когда Microsoft багу починит можно будет WSP не отключать, он не помешает.

Подробное описание бага - [https://thesharepointfarm.com/2016/03/unable-to-provision-social-features-in-sharepoint-server-2016/](https://thesharepointfarm.com/2016/03/unable-to-provision-social-features-in-sharepoint-server-2016/).

### Нет больше FIM в SharePoint
User Profile Sync Service, который по сути FIM Sync Service, появился в SharePoint 2010 и ... не работал. Потом вышел CU, который его чинит, а следущий CU сновал ломал UPS. В SharePoint 2013 UPS стал работать стабильнее, но все равно было сложности с настройкой и отладкой.

В SharePoint 2016 окончательно решили этот вопрос - выпилили FIM из SharePoint. Теперь для простых сценариев есть AD Import, а для сложных можно отдельно установить Microsoft Identity Manager (MIM, теперь FIM так называется) и настроить синхронизацию в нем. Microsoft подготовил скрипты для настройки MIM - [https://github.com/OfficeDev/PnP-Tools/tree/master/Solutions/UserProfile.MIMSync](https://github.com/OfficeDev/PnP-Tools/tree/master/Solutions/UserProfile.MIMSync).

С точки зрения лицензирования MIM Sync Engine требует только  Windows Server CAL, поэтому не увеличивает лицензионную нагрузку.

### Продолжение следует
В следующий раз я расскажу про Office Online Server, Excel Service и PowerPivot.  
Кто хочет научится устанавливать и настраивать все возможности SharePoint - приходите на тренинг.  
Описание и регистрация по ссылке [https://gandjustas.timepad.ru/event/317082/](https://gandjustas.timepad.ru/event/317082/).
 