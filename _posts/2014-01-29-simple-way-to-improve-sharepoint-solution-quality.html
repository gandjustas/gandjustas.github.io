---
layout: post
title: "Простой способ повысить качество решений"
date: '2014-01-29T10:00:00.000+04:00'
author: "Станислав Выщепан"
tags:
- ".NET"
- code quality
- C#
- "качество кода"
- SharePoint
modified_time: '2014-01-29T10:00:00.388+04:00'
thumbnail: http://lh4.ggpht.com/-bt01u-7-iyA/UubpY6KG3-I/AAAAAAAAAeY/jw7m_6Znqdg/s72-c/image_thumb%25255B1%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-1302241583051203640.post-7693513778745197518
blogger_orig_url: http://blog.gandjustas.ru/2014/01/simple-way-to-improve-sharepoint-solution-quality.html
redirect_from: /2014/01/simple-way-to-improve-sharepoint-solution-quality.html
category: SharePoint
---

<div dir="ltr" style="text-align: left;" trbidi="on">
<a href="http://lh5.ggpht.com/-MYpLra1JHHc/UubpYE3e99I/AAAAAAAAAeQ/7XnCZGM-2dQ/s1600-h/image%25255B3%25255D.png"><img align="right" alt="image" border="0" src="http://lh4.ggpht.com/-bt01u-7-iyA/UubpY6KG3-I/AAAAAAAAAeY/jw7m_6Znqdg/image_thumb%25255B1%25255D.png?imgmax=800" height="180" style="background-image: none; border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; display: inline; float: right; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="240" /></a><br />
Наверное каждый из вас сталкивался с такими решениями для SharePoint: решение вроде работает, но постоянно возникают какие-то проблемы, данные не сохраняются, странные падения при, казалось бы, безобидных операциях. Тестеры тратят много времени на такое решение, но исправление одних багов порождает другие. Развернуть такое решение на production ферме оказывается очень сложно, поддержка превращается в ад. Знакомо, да?<br />
<br />Занимаясь разработкой правил анализа кода для SPCAF (<a href="http://spcaf.com/">http://spcaf.com</a>), я нашел способ как быстро исправить такую ситуацию.<br /><a href="" name="habracut"></a><br />Найдите все блоки кода такого вида:<br />
<pre class="brush: csharp;">try
{
    //код
}
catch(Exception e)
{
    //здесь что угодно, кроме throw;
}
</pre>
<br />Впишите <code>throw;</code> в блок <code>catch</code>. Важно что в catch указывается базовый <code>Exception</code>, а не конкретный тип исключения.<br />Ваше приложение начнет падать и вам надо будет исправить все найденные ошибки, не убирая <code>throw</code>. Я такое уже проделывал много раз на разных проектах, и это давало очень положительных результат. Даже если программисты будут сопротивляться, не допускайте убирания <code>throw</code>.<br />
<h3>
Исследование</h3>
<br />
Для тестирования правил я собрал около 70 .wsp файлов, решений SharePoint. Большинство из них — проекты, в которых мне довелось участвовать, и я прекрасно знаю все проблемы, которые возникали при разработке. Я посчитал плотность блоков <code>try\catch</code> без <code>throw</code> и вот что получилось: 
<br />
<ul>
<li>Самое проблемное решение — <b>1 блок на 36 строк</b>. То есть почти каждый значимый метод был завернут в такой<code>try\catch</code>. 
</li>
<li>Решения средней паршивости — <b>1 блок на 90-100 строк</b>. В некоторых из этих решений уже были проведены чистки<code>try\catch</code>. 
</li>
<li>Хорошие решения — <b>1 блок на 120-130 строк</b>. С ними никогда не возникало проблем.</li>
</ul>
<h3>
Обоснование</h3>
<br />
Перехват всех исключений не рекомендуется практически всегда, на него ругается Visual Studio Code Analysis, об этом написано в Framework Design Guidelines. В книге Pragamtic Programmer, которую стоит прочитать всем без исключения программистам, коротко и емко сформулировано правило — Crash, don't Trash.<br />
Фактически перехват всех исключений это попытка подавить ошибку, допущенную программистом. Ошибка все равно вылезает, но не так очевидно и, зачастую, в совершенно другом месте. Это и создает проблемы при разработке решений. Особенно сильно это проявляется для SharePoint, так как его API крайне сложен.<br />
Я знаю только один случай в решениях SharePoint когда оправдано ловить все исключения и не выбрасывать их дальше — в визуальных компонентах, чтобы ошибка разработчика не завалила портал. Но даже в них стоит рассмотреть обработку конкретных типов исключений, вместо перехвата всех подряд. В остальных случаях код должен падать максимально быстро и громко, желательно сообщая о том, что пошло не так. Не надо делать никаких возвратов <code>false</code> или <code>null</code> в случае исключения, пусть код упадет, тогда разработчики и тестеры увидят ошибку, до того как её увидит пользователь. 
<br />
<h3>
&nbsp;</h3>
<h3>
Заключение</h3>
<br />
Проблема подавления ошибок актуальна не только для SharePoint решений и не только на языке C# и платформе .NET. Возможно и в других проектах вы сможете значительно улучшить ситуацию убирая подавление исключений.<br />
PS. Набор правил, которым проверял решения — <a href="http://spcafcontrib.codeplex.com/">http://spcafcontrib.codeplex.com/</a>  </div>

